# Password Management Implementation

This document describes the password management implementation for the Money Flow Guardian application.

## Overview

The application uses bcrypt for secure password hashing and storage. This provides protection against various types of attacks, including rainbow table attacks and brute force attempts.

## Technical Implementation

### Password Hashing

- Passwords are never stored in plain text
- [bcrypt](https://github.com/kelektiv/node.bcrypt.js) is used for hashing with a cost factor of 10
- Each password gets a unique salt automatically generated by bcrypt
- Password hashes are stored in the `passwordHash` field of the user object

### Authentication Flow

1. User submits email and password via the login form
2. The server looks up the user by email
3. If found, bcrypt compares the submitted password with the stored hash
4. If comparison is successful, a token is generated and returned
5. For users with 2FA enabled, a temporary token is issued that requires verification

### API Endpoints

#### Login

```
POST /api/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "securepassword"
}
```

Response:
```json
{
  "token": "uuid-token-string",
  "user": {
    "id": "user-id",
    "name": "User Name",
    "email": "user@example.com",
    "role": "user"
  },
  "requiresTwoFactor": false
}
```

#### Two-Factor Authentication

```
POST /api/auth/two-factor
Content-Type: application/json

{
  "code": "123456",
  "token": "temporary-token-from-login"
}
```

Response:
```json
{
  "token": "new-authenticated-token",
  "success": true
}
```

#### Logout

```
POST /api/auth/logout
Content-Type: application/json
Authorization: Bearer token-from-login
```

Response:
```json
{
  "success": true
}
```

#### Token Refresh

```
POST /api/auth/refresh-token
Content-Type: application/json

{
  "refreshToken": "token-to-refresh"
}
```

Response:
```json
{
  "token": "new-token"
}
```

### Password Operations

#### Create User (with hashed password)

```
POST /api/users
Content-Type: application/json

{
  "name": "New User",
  "email": "newuser@example.com",
  "password": "securepassword",
  "role": "user"
}
```

#### Update Password

```
PUT /api/users/:id/password
Content-Type: application/json

{
  "currentPassword": "oldpassword",
  "newPassword": "newpassword"
}
```

#### Reset Password (Admin function)

```
POST /api/users/:id/reset-password
Content-Type: application/json

{
  "newPassword": "newpassword"
}
```

## Security Considerations

1. **Password Complexity**: The application should enforce password complexity rules (not implemented yet)
2. **Rate Limiting**: Implement rate limiting for login attempts to prevent brute force attacks
3. **Secure Token Storage**: Tokens are stored in memory and expire after 24 hours
4. **Secure Communications**: Always use HTTPS in production

## Future Improvements

- Implement password complexity requirements
- Add password expiration policy
- Implement account lockout after failed login attempts
- Add more robust refresh token mechanism
- Consider using JWT for tokens instead of UUID

## Testing

The password management functionality can be tested using the provided API endpoints. For example:

```bash
# Create a user
curl -X POST http://localhost:8081/api/users -H "Content-Type: application/json" \
  -d '{"name":"Test User", "email":"test@example.com", "password":"Password123!", "role":"user"}'

# Login
curl -X POST http://localhost:8081/api/auth/login -H "Content-Type: application/json" \
  -d '{"email":"test@example.com", "password":"Password123!"}'

# Logout
curl -X POST http://localhost:8081/api/auth/logout -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token-from-login>"

# Reset password
curl -X POST http://localhost:8081/api/users/<user-id>/reset-password -H "Content-Type: application/json" \
  -d '{"newPassword":"NewPassword456!"}'

# Update password
curl -X PUT http://localhost:8081/api/users/<user-id>/password -H "Content-Type: application/json" \
  -d '{"currentPassword":"Password123!", "newPassword":"UpdatedPassword789!"}'
```
